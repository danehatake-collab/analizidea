<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="–ì–µ–Ω–∏–π">
    <meta name="theme-color" content="#000000">
    <title>–ì–ï–ù–ò–ô</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --card-hover: #2c2c2e;
            --border: rgba(255,255,255,0.08);
            --text: #ffffff;
            --text-secondary: rgba(255,255,255,0.6);
            --text-muted: rgba(255,255,255,0.35);
            --accent: #0a84ff;
            --green: #30d158;
            --orange: #ff9f0a;
            --purple: #bf5af2;
            --red: #ff453a;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            padding-bottom: calc(var(--safe-bottom) + 20px);
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Header */
        .header {
            padding: calc(var(--safe-top) + 12px) 16px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            background: var(--card);
            border: none;
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
        }

        .header-btn:active { opacity: 0.7; }

        /* Add Button */
        .add-btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: var(--accent);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .add-btn:active { opacity: 0.8; }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--card);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 12px;
        }

        .tab {
            flex: 1;
            padding: 11px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
        }

        .tab.active {
            background: var(--card-hover);
            color: var(--text);
        }

        .tab-badge {
            display: inline-block;
            min-width: 18px;
            padding: 0 6px;
            background: var(--accent);
            border-radius: 9px;
            font-size: 11px;
            margin-left: 6px;
            color: white;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: var(--card);
            border-radius: 10px;
            padding: 3px;
            margin-bottom: 12px;
        }

        .view-btn {
            flex: 1;
            padding: 9px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
        }

        .view-btn.active {
            background: var(--card-hover);
            color: var(--text);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .ctrl-btn {
            flex: 1;
            padding: 11px;
            background: var(--card);
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .ctrl-btn:active { background: var(--card-hover); }

        /* Cards */
        .cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cards.hidden { display: none; }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .card-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .card-tag {
            font-size: 11px;
            padding: 4px 10px;
            background: var(--card-hover);
            border-radius: 8px;
            color: var(--text-secondary);
        }

        .card-hook {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .card-visual {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .card-stats {
            display: flex;
            gap: 14px;
            margin-bottom: 10px;
        }

        .stat {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat span { font-weight: 700; }
        .stat.views span { color: var(--accent); }
        .stat.shares span { color: var(--purple); }
        .stat.comments span { color: var(--green); }
        .stat.subs span { color: var(--orange); }

        .card-insight {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 10px 12px;
            background: rgba(255,255,255,0.04);
            border-radius: 10px;
            margin-bottom: 10px;
            line-height: 1.45;
        }

        .card-idea {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 10px 12px;
            background: rgba(191, 90, 242, 0.1);
            border-left: 3px solid var(--purple);
            border-radius: 10px;
            margin-bottom: 10px;
            line-height: 1.45;
        }

        .card-idea-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--purple);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .card-btn.open {
            background: var(--accent);
            color: white;
        }

        .card-btn.edit {
            background: var(--card-hover);
            color: var(--text-secondary);
            flex: 0.5;
        }

        .card-btn.delete {
            background: rgba(255, 69, 58, 0.12);
            color: var(--red);
            flex: 0.5;
        }

        /* Table View */
        .table-container {
            display: none;
            overflow-x: auto;
            background: var(--card);
            border-radius: 14px;
            margin-bottom: 16px;
        }

        .table-container.visible { display: block; }

        .data-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: var(--card-hover);
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            color: var(--text-secondary);
        }

        .data-table tr:last-child td { border-bottom: none; }

        .data-table .hook-cell {
            color: var(--text);
            font-weight: 500;
            max-width: 150px;
        }

        .data-table .num-cell {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .data-table .num-cell.views { color: var(--accent); }
        .data-table .num-cell.shares { color: var(--purple); }
        .data-table .num-cell.comments { color: var(--green); }
        .data-table .num-cell.subs { color: var(--orange); }

        .table-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 11px;
        }

        .table-actions {
            display: flex;
            gap: 4px;
        }

        .table-action {
            width: 26px;
            height: 26px;
            border: none;
            background: var(--bg);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .table-action:active { opacity: 0.7; }
        .table-action.del { color: var(--red); }

        /* Empty */
        .empty {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-muted);
        }

        .empty-icon { font-size: 40px; margin-bottom: 10px; }
        .empty-text { font-size: 14px; }

        /* Divider */
        .divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        /* Section */
        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* Streak */
        .streak-row {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--card);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .streak-fire { font-size: 28px; }

        .streak-num {
            font-size: 24px;
            font-weight: 700;
            color: var(--orange);
        }

        .streak-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .streak-days {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .streak-day {
            width: 26px;
            height: 26px;
            border-radius: 8px;
            background: var(--card-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .streak-day.active {
            background: linear-gradient(135deg, #ff9f0a, #ff453a);
            color: white;
        }

        .streak-day.today {
            box-shadow: 0 0 0 2px var(--orange);
        }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .stat-box {
            flex: 1;
            background: var(--card);
            border-radius: 14px;
            padding: 14px;
            text-align: center;
        }

        .stat-box-value {
            font-size: 22px;
            font-weight: 700;
        }

        .stat-box-value.blue { color: var(--accent); }
        .stat-box-value.green { color: var(--green); }
        .stat-box-value.purple { color: var(--purple); }

        .stat-box-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Buttons */
        .ach-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, rgba(255, 214, 10, 0.12), rgba(255, 159, 10, 0.12));
            border: 1px solid rgba(255, 214, 10, 0.25);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #ffd60a;
            cursor: pointer;
            margin-bottom: 10px;
        }

        /* Modal */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            align-items: flex-end;
        }

        .modal-bg.show { display: flex; }

        .modal {
            background: #1c1c1e;
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            max-height: 90vh;
            overflow-y: auto;
            padding: 16px 20px calc(var(--safe-bottom) + 20px);
        }

        .modal-handle {
            width: 36px;
            height: 5px;
            background: rgba(255,255,255,0.25);
            border-radius: 3px;
            margin: 0 auto 14px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .modal-title {
            font-size: 17px;
            font-weight: 700;
        }

        .modal-close {
            width: 28px;
            height: 28px;
            background: var(--card-hover);
            border: none;
            border-radius: 50%;
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
        }

        .form-group { margin-bottom: 14px; }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            color: var(--text);
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-input::placeholder { color: var(--text-muted); }

        textarea.form-input {
            min-height: 70px;
            resize: none;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group { flex: 1; }

        /* Tags with custom input */
        .tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .tag-btn {
            padding: 9px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .tag-btn.selected {
            background: rgba(10, 132, 255, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        .custom-tag-input {
            flex: 1;
            min-width: 80px;
            padding: 9px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 12px;
            color: var(--text);
            font-family: inherit;
        }

        .custom-tag-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .custom-tag-input::placeholder { color: var(--text-muted); }

        .visual-upload {
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: var(--bg);
        }

        .visual-upload:active { background: var(--card); }

        .visual-upload-icon { font-size: 24px; margin-bottom: 4px; }
        .visual-upload-text { font-size: 12px; color: var(--text-muted); }

        .visual-preview {
            width: 100%;
            max-height: 150px;
            object-fit: contain;
            border-radius: 10px;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            margin-top: 6px;
        }

        .cancel-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: none;
            font-size: 14px;
            color: var(--text-muted);
            cursor: pointer;
            margin-top: 6px;
        }

        /* Filter Chips */
        .filter-chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }

        .filter-chip {
            padding: 8px 14px;
            background: var(--bg);
            border: none;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
        }

        .filter-chip.active {
            background: var(--text);
            color: var(--bg);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: calc(var(--safe-bottom) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: white;
            color: black;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 200;
            opacity: 0;
            transition: all 0.3s;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast-undo {
            padding: 5px 10px;
            background: rgba(0,0,0,0.1);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Achievement Popup */
        .ach-popup {
            position: fixed;
            top: calc(var(--safe-top) + 50px);
            left: 50%;
            transform: translateX(-50%) translateY(-30px);
            background: linear-gradient(135deg, #ffd60a, #ff9f0a);
            padding: 12px 20px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 300;
            opacity: 0;
            transition: all 0.4s;
            box-shadow: 0 6px 24px rgba(255, 214, 10, 0.4);
        }

        .ach-popup.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .ach-popup-text {
            font-size: 14px;
            font-weight: 700;
            color: black;
        }

        /* Confetti */
        .confetti-box {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        @keyframes fall {
            0% { transform: translateY(-50px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Ach Grid */
        .ach-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 14px;
        }

        .ach-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }

        .ach-item.unlocked {
            background: rgba(255, 214, 10, 0.1);
            border: 1px solid rgba(255, 214, 10, 0.25);
        }

        .ach-item.locked { opacity: 0.5; }
        .ach-icon { font-size: 28px; margin-bottom: 4px; }
        .ach-name { font-size: 11px; font-weight: 700; }
        .ach-desc { font-size: 9px; color: var(--text-muted); }

        .ach-bar {
            height: 3px;
            background: var(--card-hover);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .ach-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd60a, #ff9f0a);
        }

        /* Top */
        .top-item {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: var(--bg);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .top-rank {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            background: var(--card-hover);
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .top-rank.r1 { background: linear-gradient(135deg, #ffd60a, #ff9f0a); color: black; }
        .top-rank.r2 { background: linear-gradient(135deg, #c0c0c0, #888); color: black; }
        .top-rank.r3 { background: linear-gradient(135deg, #cd7f32, #a05a2c); color: white; }

        .top-content { flex: 1; min-width: 0; }
        .top-hook { font-size: 13px; font-weight: 600; margin-bottom: 3px; }
        .top-stats { font-size: 11px; color: var(--text-muted); }

        .top-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 12px;
        }

        .top-tab {
            flex: 1;
            padding: 9px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
        }

        .top-tab.active {
            background: var(--card-hover);
            color: var(--text);
        }

        /* Settings */
        .settings-group {
            background: var(--bg);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 14px;
        }

        .settings-item {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child { border-bottom: none; }

        .settings-label {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-action {
            padding: 6px 12px;
            background: var(--card-hover);
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
        }

        .top-list {
            max-height: 50vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="confetti-box" id="confetti"></div>
    
    <div class="ach-popup" id="ach-popup">
        <span id="ach-popup-icon">üèÜ</span>
        <span class="ach-popup-text" id="ach-popup-text">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!</span>
    </div>

    <header class="header">
        <h1>üß† –ì–µ–Ω–∏–π</h1>
        <button class="header-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </header>

    <div class="container">
        <button class="add-btn" onclick="openModal()">+ –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>

        <div class="tabs">
            <button class="tab active" data-tab="comp" onclick="switchTab('comp')">
                –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã <span class="tab-badge" id="comp-badge">0</span>
            </button>
            <button class="tab" data-tab="my" onclick="switchTab('my')">
                –ú–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç <span class="tab-badge" id="my-badge">0</span>
            </button>
        </div>

        <div class="view-toggle">
            <button class="view-btn active" data-v="cards" onclick="setView('cards')">üóÇÔ∏è –ö–∞—Ä—Ç–æ—á–∫–∏</button>
            <button class="view-btn" data-v="table" onclick="setView('table')">üìã –¢–∞–±–ª–∏—Ü–∞</button>
        </div>

        <div class="controls">
            <button class="ctrl-btn" onclick="openTop()">üèÜ –¢–æ–ø</button>
            <button class="ctrl-btn" onclick="exportCSV()">üìä CSV</button>
        </div>

        <div id="comp-content">
            <div class="cards" id="comp-cards"></div>
            <div class="table-container" id="comp-table"></div>
        </div>

        <div id="my-content" style="display:none">
            <div class="cards" id="my-cards"></div>
            <div class="table-container" id="my-table"></div>
        </div>

        <div class="divider"></div>

        <div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>

        <div class="streak-row">
            <div class="streak-fire">üî•</div>
            <div>
                <div class="streak-num" id="streak-num">0</div>
                <div class="streak-label">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
            </div>
            <div class="streak-days" id="streak-days"></div>
        </div>

        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-box-value blue" id="stat-comp">0</div>
                <div class="stat-box-label">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value green" id="stat-my">0</div>
                <div class="stat-box-label">–ú–æ–∏—Ö</div>
            </div>
            <div class="stat-box">
                <div class="stat-box-value purple" id="stat-week">0</div>
                <div class="stat-box-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>
        </div>

        <button class="ach-btn" onclick="openAchievements()">
            üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è <span id="ach-badge">0/6</span>
        </button>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal-bg" id="modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title" id="modal-title">–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</div>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>

            <form id="form">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-type">

                <div class="form-group">
                    <label class="form-label">–•—É–∫ *</label>
                    <textarea class="form-input" id="f-hook" placeholder="–ß—Ç–æ –∑–∞—Ü–µ–ø–∏–ª–æ?" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ Reels</label>
                    <input type="url" class="form-input" id="f-link" placeholder="https://instagram.com/reel/...">
                </div>

                <div class="form-group" id="visual-group">
                    <label class="form-label">–°–∫—Ä–∏–Ω—à–æ—Ç</label>
                    <div class="visual-upload" id="visual-area" onclick="document.getElementById('visual-file').click()">
                        <div id="visual-preview">
                            <div class="visual-upload-icon">üì∑</div>
                            <div class="visual-upload-text">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
                        </div>
                    </div>
                    <input type="file" id="visual-file" accept="image/*" style="display:none" onchange="handleVisual(this)">
                    <input type="hidden" id="f-visual">
                </div>

                <div class="form-row" id="stats-row">
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</label>
                        <input type="text" class="form-input" id="f-views" placeholder="1.2–º">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–†–µ–ø–æ—Å—Ç—ã</label>
                        <input type="text" class="form-input" id="f-shares" placeholder="50–∫">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ö–æ–º–º–µ–Ω—Ç—ã</label>
                        <input type="text" class="form-input" id="f-comments" placeholder="1–∫">
                    </div>
                </div>

                <div class="form-row" id="my-stats-row" style="display:none">
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</label>
                        <input type="text" class="form-input" id="f-my-views" placeholder="10–∫">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</label>
                        <input type="text" class="form-input" id="f-subs" placeholder="+150">
                    </div>
                </div>

                <div class="form-group" id="format-group">
                    <label class="form-label">–§–æ—Ä–º–∞—Ç</label>
                    <div class="tags-row" id="tags">
                        <button type="button" class="tag-btn" data-v="–ì–æ–ª–æ–≤–∞" onclick="selectTag(this)">üó£Ô∏è –ì–æ–ª–æ–≤–∞</button>
                        <button type="button" class="tag-btn" data-v="–°–ø–ª–∏—Ç" onclick="selectTag(this)">üì± –°–ø–ª–∏—Ç</button>
                        <button type="button" class="tag-btn" data-v="B-roll" onclick="selectTag(this)">üé• B-roll</button>
                        <button type="button" class="tag-btn" data-v="–î–∏–∞–ª–æ–≥" onclick="selectTag(this)">üé≠ –î–∏–∞–ª–æ–≥</button>
                        <input type="text" class="custom-tag-input" id="custom-format" placeholder="–°–≤–æ–π..." oninput="onCustomFormat()">
                    </div>
                    <input type="hidden" id="f-format">
                </div>

                <div class="form-group">
                    <label class="form-label">–ò–Ω—Å–∞–π—Ç</label>
                    <textarea class="form-input" id="f-insight" placeholder="–ü–æ—á–µ–º—É —Å—Ä–∞–±–æ—Ç–∞–ª–æ?"></textarea>
                </div>

                <div class="form-group" id="idea-group">
                    <label class="form-label">–ú–æ—è –∏–¥–µ—è</label>
                    <textarea class="form-input" id="f-idea" placeholder="–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?"></textarea>
                </div>

                <button type="button" class="submit-btn" onclick="save()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="cancel-btn" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </form>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal-bg" id="ach-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                <button class="modal-close" onclick="closeAchModal()">‚úï</button>
            </div>
            <div class="ach-grid" id="ach-grid"></div>
            <button class="cancel-btn" onclick="closeAchModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Top Modal -->
    <div class="modal-bg" id="top-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">üèÜ –¢–æ–ø —Ä–æ–ª–∏–∫–æ–≤</div>
                <button class="modal-close" onclick="closeTopModal()">‚úï</button>
            </div>
            <div class="top-tabs">
                <button class="top-tab active" data-t="comp" onclick="switchTopTab('comp')">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã</button>
                <button class="top-tab" data-t="my" onclick="switchTopTab('my')">–ú–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç</button>
            </div>
            <div class="filter-chips" id="sort-chips">
                <button class="filter-chip active" data-s="views" onclick="setSort('views')">üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä—ã</button>
                <button class="filter-chip" data-s="shares" onclick="setSort('shares')">üîÑ –†–µ–ø–æ—Å—Ç—ã</button>
                <button class="filter-chip" data-s="comments" onclick="setSort('comments')">üí¨ –ö–æ–º–º–µ–Ω—Ç—ã</button>
            </div>
            <div class="top-list" id="top-list"></div>
            <button class="cancel-btn" onclick="closeTopModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-bg" id="settings-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <button class="modal-close" onclick="closeSettingsModal()">‚úï</button>
            </div>
            <div class="settings-group">
                <div class="settings-item">
                    <span class="settings-label">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                    <button class="settings-action" onclick="exportJSON()">JSON</button>
                </div>
                <div class="settings-item">
                    <span class="settings-label">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                    <button class="settings-action" onclick="document.getElementById('import-file').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJSON(this)">
                </div>
                <div class="settings-item">
                    <span class="settings-label">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</span>
                    <button class="settings-action" style="color:var(--red)" onclick="clearAll()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-item">
                    <span class="settings-label">–í–µ—Ä—Å–∏—è</span>
                    <span style="color:var(--text-muted)">6.0</span>
                </div>
            </div>
            <button class="cancel-btn" onclick="closeSettingsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toast-text">–£–¥–∞–ª–µ–Ω–æ</span>
        <button class="toast-undo" id="toast-undo" onclick="undo()">–í–µ—Ä–Ω—É—Ç—å</button>
    </div>

    <script>
        var compData = [], myData = [], stats = {};
        var currentTab = 'comp';
        var currentView = 'cards';
        var topTab = 'comp';
        var sortBy = 'views';
        var deleted = null, deletedFrom = null;
        var toastTimer = null;

        var achievements = [
            { id: 'first', name: '–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏', desc: '10 –∞–Ω–∞–ª–∏–∑–æ–≤', icon: 'üå±', target: 10 },
            { id: 'hunter', name: '–û—Ö–æ—Ç–Ω–∏–∫', desc: '50 –∞–Ω–∞–ª–∏–∑–æ–≤', icon: 'üéØ', target: 50 },
            { id: 'genius', name: '–ì–µ–Ω–∏–π', desc: '100 –∞–Ω–∞–ª–∏–∑–æ–≤', icon: 'üß†', target: 100 },
            { id: 'streak7', name: '–ù–µ–¥–µ–ª—è', desc: '7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: 'üî•', target: 7, type: 'streak' },
            { id: 'streak30', name: '–ú–µ—Å—è—Ü', desc: '30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: 'üí™', target: 30, type: 'streak' },
            { id: 'viral', name: '–í–∏—Ä—É—Å–æ–ª–æ–≥', desc: '5 —Ä–æ–ª–∏–∫–æ–≤ >1–º', icon: 'ü¶†', target: 5, type: 'viral' }
        ];

        try { compData = JSON.parse(localStorage.getItem('g_comp')) || []; } catch(e) {}
        try { myData = JSON.parse(localStorage.getItem('g_my')) || []; } catch(e) {}
        try { stats = JSON.parse(localStorage.getItem('g_stats')) || { streak: 0, last: null, unlocked: [], days: {} }; } catch(e) { stats = { streak: 0, last: null, unlocked: [], days: {} }; }

        document.addEventListener('DOMContentLoaded', function() {
            updateStreak();
            render();
            updateStats();
            updateStreakDays();
            checkAch();
        });

        // Paste image
        document.addEventListener('paste', function(e) {
            var modal = document.getElementById('modal');
            if (!modal.classList.contains('show')) return;
            var items = e.clipboardData.items;
            for (var i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    var reader = new FileReader();
                    reader.onload = function(ev) {
                        document.getElementById('f-visual').value = ev.target.result;
                        document.getElementById('visual-preview').innerHTML = '<img src="' + ev.target.result + '" class="visual-preview">';
                    };
                    reader.readAsDataURL(items[i].getAsFile());
                    break;
                }
            }
        });

        function handleVisual(input) {
            var file = input.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('f-visual').value = e.target.result;
                document.getElementById('visual-preview').innerHTML = '<img src="' + e.target.result + '" class="visual-preview">';
            };
            reader.readAsDataURL(file);
        }

        function updateStreak() {
            var today = new Date().toISOString().split('T')[0];
            var yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            if (stats.last === today) return;
            if (stats.last === yesterday) stats.streak++;
            else if (stats.last !== today) stats.streak = 1;
            stats.last = today;
            stats.days[today] = stats.days[today] || 0;
            saveStats();
        }

        function updateStreakDays() {
            var el = document.getElementById('streak-days');
            var html = '';
            var today = new Date();
            for (var i = 6; i >= 0; i--) {
                var d = new Date(today);
                d.setDate(d.getDate() - i);
                var ds = d.toISOString().split('T')[0];
                var num = d.getDate();
                var active = stats.days[ds] > 0;
                var isToday = i === 0;
                html += '<div class="streak-day' + (active ? ' active' : '') + (isToday ? ' today' : '') + '">' + num + '</div>';
            }
            el.innerHTML = html;
            document.getElementById('streak-num').textContent = stats.streak;
        }

        function recordActivity() {
            var today = new Date().toISOString().split('T')[0];
            stats.days[today] = (stats.days[today] || 0) + 1;
            updateStreak();
            updateStreakDays();
        }

        function updateStats() {
            document.getElementById('stat-comp').textContent = compData.length;
            document.getElementById('stat-my').textContent = myData.length;
            document.getElementById('comp-badge').textContent = compData.length;
            document.getElementById('my-badge').textContent = myData.length;
            var week = new Date();
            week.setDate(week.getDate() - 7);
            var wc = 0;
            compData.forEach(function(i) { if (new Date(i.date) >= week) wc++; });
            myData.forEach(function(i) { if (new Date(i.date) >= week) wc++; });
            document.getElementById('stat-week').textContent = wc;
        }

        function checkAch() {
            var total = compData.length + myData.length;
            var viral = compData.filter(function(i) { return i.views >= 1000000; }).length;
            achievements.forEach(function(a) {
                if (stats.unlocked.indexOf(a.id) > -1) return;
                var prog = a.type === 'streak' ? stats.streak : (a.type === 'viral' ? viral : total);
                if (prog >= a.target) {
                    stats.unlocked.push(a.id);
                    showAchPopup(a.icon, a.name);
                    confetti();
                    saveStats();
                }
            });
            document.getElementById('ach-badge').textContent = stats.unlocked.length + '/' + achievements.length;
        }

        function showAchPopup(icon, text) {
            var el = document.getElementById('ach-popup');
            document.getElementById('ach-popup-icon').textContent = icon;
            document.getElementById('ach-popup-text').textContent = text;
            el.classList.add('show');
            setTimeout(function() { el.classList.remove('show'); }, 3000);
        }

        function confetti() {
            var box = document.getElementById('confetti');
            var colors = ['#ff453a', '#ff9f0a', '#ffd60a', '#30d158', '#0a84ff', '#bf5af2'];
            for (var i = 0; i < 40; i++) {
                var p = document.createElement('div');
                p.className = 'confetti-piece';
                p.style.left = Math.random() * 100 + '%';
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                p.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                p.style.animation = 'fall ' + (2 + Math.random() * 2) + 's ease-out forwards';
                p.style.animationDelay = Math.random() * 0.5 + 's';
                box.appendChild(p);
                setTimeout(function(el) { el.remove(); }.bind(null, p), 4000);
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(function(t) {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            document.getElementById('comp-content').style.display = tab === 'comp' ? 'block' : 'none';
            document.getElementById('my-content').style.display = tab === 'my' ? 'block' : 'none';
            render();
        }

        function setView(v) {
            currentView = v;
            document.querySelectorAll('.view-btn').forEach(function(b) {
                b.classList.toggle('active', b.dataset.v === v);
            });
            render();
        }

        function render() {
            renderCards('comp', compData);
            renderCards('my', myData);
            renderTable('comp', compData);
            renderTable('my', myData);
        }

        function renderCards(type, data) {
            var el = document.getElementById(type + '-cards');
            var isVisible = currentView === 'cards';
            el.classList.toggle('hidden', !isVisible);
            if (!isVisible) return;

            if (data.length === 0) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">' + (type === 'comp' ? 'üë•' : 'üé¨') + '</div><div class="empty-text">–î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑</div></div>';
                return;
            }
            var html = '';
            data.forEach(function(item) {
                html += '<div class="card">';
                html += '<div class="card-header">';
                html += '<span class="card-date">' + formatDate(item.date) + '</span>';
                if (item.format) html += '<span class="card-tag">' + esc(item.format) + '</span>';
                html += '</div>';
                html += '<div class="card-hook">' + esc(item.hook) + '</div>';
                
                if (item.visual) html += '<img src="' + item.visual + '" class="card-visual">';
                
                var hasStats = item.views || item.shares || item.comments || item.subs;
                if (hasStats) {
                    html += '<div class="card-stats">';
                    if (item.views) html += '<div class="stat views">üëÄ <span>' + formatNum(item.views) + '</span></div>';
                    if (item.shares) html += '<div class="stat shares">üîÑ <span>' + formatNum(item.shares) + '</span></div>';
                    if (item.comments) html += '<div class="stat comments">üí¨ <span>' + formatNum(item.comments) + '</span></div>';
                    if (item.subs) html += '<div class="stat subs">‚ûï <span>' + formatNum(item.subs) + '</span></div>';
                    html += '</div>';
                }
                
                if (item.insight) html += '<div class="card-insight">' + esc(item.insight) + '</div>';
                if (item.idea) html += '<div class="card-idea"><div class="card-idea-label">–ú–æ—è –∏–¥–µ—è</div>' + esc(item.idea) + '</div>';
                
                html += '<div class="card-actions">';
                if (item.link) html += '<button class="card-btn open" onclick="openLink(\'' + esc(item.link) + '\')">–û—Ç–∫—Ä—ã—Ç—å Reels</button>';
                html += '<button class="card-btn edit" onclick="edit(\'' + type + '\', \'' + item.id + '\')">‚úèÔ∏è</button>';
                html += '<button class="card-btn delete" onclick="del(\'' + type + '\', \'' + item.id + '\')">üóëÔ∏è</button>';
                html += '</div>';
                html += '</div>';
            });
            el.innerHTML = html;
        }

        function renderTable(type, data) {
            var el = document.getElementById(type + '-table');
            var isVisible = currentView === 'table';
            el.classList.toggle('visible', isVisible);
            if (!isVisible) return;

            if (data.length === 0) {
                el.innerHTML = '<div class="empty"><div class="empty-icon">' + (type === 'comp' ? 'üë•' : 'üé¨') + '</div><div class="empty-text">–î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑</div></div>';
                return;
            }

            var html = '<table class="data-table"><thead><tr>';
            if (type === 'comp') {
                html += '<th>–î–∞—Ç–∞</th><th>–•—É–∫</th><th>–§–æ—Ä–º–∞—Ç</th><th>üëÄ</th><th>üîÑ</th><th>üí¨</th><th>–°—Å—ã–ª–∫–∞</th><th></th>';
            } else {
                html += '<th>–î–∞—Ç–∞</th><th>–•—É–∫</th><th>üëÄ</th><th>‚ûï</th><th>–°—Å—ã–ª–∫–∞</th><th></th>';
            }
            html += '</tr></thead><tbody>';

            data.forEach(function(item) {
                html += '<tr>';
                html += '<td>' + formatDate(item.date) + '</td>';
                html += '<td class="hook-cell">' + esc(item.hook) + '</td>';
                
                if (type === 'comp') {
                    html += '<td>' + (item.format ? esc(item.format) : '‚Äî') + '</td>';
                    html += '<td class="num-cell views">' + formatNum(item.views) + '</td>';
                    html += '<td class="num-cell shares">' + formatNum(item.shares) + '</td>';
                    html += '<td class="num-cell comments">' + formatNum(item.comments) + '</td>';
                } else {
                    html += '<td class="num-cell views">' + formatNum(item.views) + '</td>';
                    html += '<td class="num-cell subs">' + formatNum(item.subs) + '</td>';
                }
                
                html += '<td>' + (item.link ? '<a href="' + esc(item.link) + '" target="_blank" class="table-link">–û—Ç–∫—Ä—ã—Ç—å</a>' : '‚Äî') + '</td>';
                html += '<td><div class="table-actions">';
                html += '<button class="table-action" onclick="edit(\'' + type + '\', \'' + item.id + '\')">‚úèÔ∏è</button>';
                html += '<button class="table-action del" onclick="del(\'' + type + '\', \'' + item.id + '\')">üóëÔ∏è</button>';
                html += '</div></td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
            el.innerHTML = html;
        }

        function openLink(url) {
            window.open(url, '_blank');
        }

        function openModal() {
            document.getElementById('modal-title').textContent = '–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑';
            document.getElementById('form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('edit-type').value = currentTab;
            document.getElementById('f-format').value = '';
            document.getElementById('f-visual').value = '';
            document.getElementById('custom-format').value = '';
            document.getElementById('visual-preview').innerHTML = '<div class="visual-upload-icon">üì∑</div><div class="visual-upload-text">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>';
            document.querySelectorAll('.tag-btn').forEach(function(t) { t.classList.remove('selected'); });
            
            var isComp = currentTab === 'comp';
            document.getElementById('stats-row').style.display = isComp ? 'flex' : 'none';
            document.getElementById('my-stats-row').style.display = isComp ? 'none' : 'flex';
            document.getElementById('format-group').style.display = isComp ? 'block' : 'none';
            document.getElementById('idea-group').style.display = isComp ? 'block' : 'none';
            document.getElementById('visual-group').style.display = isComp ? 'block' : 'none';
            
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        function selectTag(btn) {
            document.querySelectorAll('.tag-btn').forEach(function(t) { t.classList.remove('selected'); });
            btn.classList.add('selected');
            document.getElementById('f-format').value = btn.dataset.v;
            document.getElementById('custom-format').value = '';
        }

        function onCustomFormat() {
            var val = document.getElementById('custom-format').value.trim();
            if (val) {
                document.querySelectorAll('.tag-btn').forEach(function(t) { t.classList.remove('selected'); });
                document.getElementById('f-format').value = val;
            }
        }

        function edit(type, id) {
            var data = type === 'comp' ? compData : myData;
            var item = data.find(function(i) { return i.id === id; });
            if (!item) return;

            document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-type').value = type;
            document.getElementById('f-hook').value = item.hook;
            document.getElementById('f-link').value = item.link || '';
            document.getElementById('f-insight').value = item.insight || '';
            document.getElementById('f-visual').value = item.visual || '';
            
            if (item.visual) {
                document.getElementById('visual-preview').innerHTML = '<img src="' + item.visual + '" class="visual-preview">';
            } else {
                document.getElementById('visual-preview').innerHTML = '<div class="visual-upload-icon">üì∑</div><div class="visual-upload-text">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>';
            }
            
            var isComp = type === 'comp';
            document.getElementById('stats-row').style.display = isComp ? 'flex' : 'none';
            document.getElementById('my-stats-row').style.display = isComp ? 'none' : 'flex';
            document.getElementById('format-group').style.display = isComp ? 'block' : 'none';
            document.getElementById('idea-group').style.display = isComp ? 'block' : 'none';
            document.getElementById('visual-group').style.display = isComp ? 'block' : 'none';

            if (isComp) {
                document.getElementById('f-views').value = item.views ? formatNum(item.views) : '';
                document.getElementById('f-shares').value = item.shares ? formatNum(item.shares) : '';
                document.getElementById('f-comments').value = item.comments ? formatNum(item.comments) : '';
                document.getElementById('f-format').value = item.format || '';
                document.getElementById('f-idea').value = item.idea || '';
                
                // Check if format is preset or custom
                var presetFormats = ['–ì–æ–ª–æ–≤–∞', '–°–ø–ª–∏—Ç', 'B-roll', '–î–∏–∞–ª–æ–≥'];
                var isPreset = presetFormats.indexOf(item.format) > -1;
                
                document.querySelectorAll('.tag-btn').forEach(function(t) {
                    t.classList.toggle('selected', t.dataset.v === item.format);
                });
                
                if (item.format && !isPreset) {
                    document.getElementById('custom-format').value = item.format;
                } else {
                    document.getElementById('custom-format').value = '';
                }
            } else {
                document.getElementById('f-my-views').value = item.views ? formatNum(item.views) : '';
                document.getElementById('f-subs').value = item.subs ? formatNum(item.subs) : '';
            }

            document.getElementById('modal').classList.add('show');
        }

        function save() {
            var hook = document.getElementById('f-hook').value.trim();
            if (!hook) { alert('–í–≤–µ–¥–∏ —Ö—É–∫'); return; }

            var editId = document.getElementById('edit-id').value;
            var type = document.getElementById('edit-type').value;
            var isEdit = editId !== '';
            var isComp = type === 'comp';

            var entry = {
                id: isEdit ? editId : Date.now().toString(),
                date: new Date().toISOString().split('T')[0],
                hook: hook,
                link: document.getElementById('f-link').value.trim(),
                insight: document.getElementById('f-insight').value.trim()
            };

            if (isComp) {
                entry.views = parseNum(document.getElementById('f-views').value);
                entry.shares = parseNum(document.getElementById('f-shares').value);
                entry.comments = parseNum(document.getElementById('f-comments').value);
                entry.format = document.getElementById('f-format').value;
                entry.idea = document.getElementById('f-idea').value.trim();
                entry.visual = document.getElementById('f-visual').value;
            } else {
                entry.views = parseNum(document.getElementById('f-my-views').value);
                entry.subs = parseNum(document.getElementById('f-subs').value);
            }

            var data = isComp ? compData : myData;
            var key = isComp ? 'g_comp' : 'g_my';

            if (isEdit) {
                var idx = data.findIndex(function(i) { return i.id === editId; });
                if (idx > -1) data[idx] = entry;
            } else {
                data.unshift(entry);
                recordActivity();
                var total = compData.length + myData.length;
                if ([10, 25, 50, 100].indexOf(total) > -1) confetti();
            }

            localStorage.setItem(key, JSON.stringify(data));
            closeModal();
            render();
            updateStats();
            checkAch();
            toast(isEdit ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì' : '–î–æ–±–∞–≤–ª–µ–Ω–æ ‚úì', false);
        }

        function del(type, id) {
            var data = type === 'comp' ? compData : myData;
            var idx = data.findIndex(function(i) { return i.id === id; });
            if (idx === -1) return;
            deleted = data[idx];
            deletedFrom = type;
            data.splice(idx, 1);
            localStorage.setItem(type === 'comp' ? 'g_comp' : 'g_my', JSON.stringify(data));
            render();
            updateStats();
            toast('–£–¥–∞–ª–µ–Ω–æ', true);
        }

        function undo() {
            if (!deleted) return;
            var data = deletedFrom === 'comp' ? compData : myData;
            data.unshift(deleted);
            localStorage.setItem(deletedFrom === 'comp' ? 'g_comp' : 'g_my', JSON.stringify(data));
            deleted = null;
            deletedFrom = null;
            hideToast();
            render();
            updateStats();
        }

        function toast(text, showUndo) {
            var el = document.getElementById('toast');
            document.getElementById('toast-text').textContent = text;
            document.getElementById('toast-undo').style.display = showUndo ? 'inline-block' : 'none';
            clearTimeout(toastTimer);
            el.classList.add('show');
            toastTimer = setTimeout(hideToast, showUndo ? 4000 : 2000);
        }

        function hideToast() {
            document.getElementById('toast').classList.remove('show');
        }

        function openAchievements() {
            var grid = document.getElementById('ach-grid');
            var total = compData.length + myData.length;
            var viral = compData.filter(function(i) { return i.views >= 1000000; }).length;
            var html = '';
            achievements.forEach(function(a) {
                var unlocked = stats.unlocked.indexOf(a.id) > -1;
                var prog = a.type === 'streak' ? stats.streak : (a.type === 'viral' ? viral : total);
                var pct = Math.min(100, (prog / a.target) * 100);
                html += '<div class="ach-item ' + (unlocked ? 'unlocked' : 'locked') + '">';
                html += '<div class="ach-icon">' + a.icon + '</div>';
                html += '<div class="ach-name">' + a.name + '</div>';
                html += '<div class="ach-desc">' + a.desc + '</div>';
                if (!unlocked) html += '<div class="ach-bar"><div class="ach-bar-fill" style="width:' + pct + '%"></div></div>';
                html += '</div>';
            });
            grid.innerHTML = html;
            document.getElementById('ach-modal').classList.add('show');
        }

        function closeAchModal() {
            document.getElementById('ach-modal').classList.remove('show');
        }

        // TOP
        function openTop() {
            renderTop();
            document.getElementById('top-modal').classList.add('show');
        }

        function closeTopModal() {
            document.getElementById('top-modal').classList.remove('show');
        }

        function switchTopTab(tab) {
            topTab = tab;
            document.querySelectorAll('.top-tab').forEach(function(t) {
                t.classList.toggle('active', t.dataset.t === tab);
            });
            var chips = document.querySelectorAll('[data-s="shares"], [data-s="comments"]');
            chips.forEach(function(c) { c.style.display = tab === 'my' ? 'none' : ''; });
            if (tab === 'my' && (sortBy === 'shares' || sortBy === 'comments')) {
                setSort('views');
            }
            renderTop();
        }

        function setSort(s) {
            sortBy = s;
            document.querySelectorAll('.filter-chip').forEach(function(c) {
                c.classList.toggle('active', c.dataset.s === s);
            });
            renderTop();
        }

        function renderTop() {
            var data = (topTab === 'comp' ? compData : myData).slice();
            var list = document.getElementById('top-list');
            
            if (data.length === 0) {
                list.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-text">–ü—É—Å—Ç–æ</div></div>';
                return;
            }

            data.sort(function(a, b) {
                return (b[sortBy] || 0) - (a[sortBy] || 0);
            });

            var html = '';
            data.slice(0, 15).forEach(function(item, i) {
                var rc = i === 0 ? 'r1' : (i === 1 ? 'r2' : (i === 2 ? 'r3' : ''));
                html += '<div class="top-item">';
                html += '<div class="top-rank ' + rc + '">' + (i + 1) + '</div>';
                html += '<div class="top-content">';
                html += '<div class="top-hook">' + esc(item.hook) + '</div>';
                html += '<div class="top-stats">';
                if (sortBy === 'views') html += 'üëÄ ' + formatNum(item.views);
                else if (sortBy === 'shares') html += 'üîÑ ' + formatNum(item.shares);
                else if (sortBy === 'comments') html += 'üí¨ ' + formatNum(item.comments);
                if (item.subs && topTab === 'my') html += ' ¬∑ ‚ûï ' + formatNum(item.subs);
                html += '</div>';
                html += '</div></div>';
            });
            list.innerHTML = html;
        }

        // SETTINGS
        function openSettings() {
            document.getElementById('settings-modal').classList.add('show');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
        }

        function exportJSON() {
            var data = {
                version: '6.0',
                exported: new Date().toISOString(),
                competitors: compData,
                myContent: myData,
                stats: stats
            };
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            if (navigator.share) {
                var file = new File([blob], 'genius-backup.json', { type: 'application/json' });
                navigator.share({ files: [file] }).catch(function() {
                    downloadBlob(blob, 'genius-backup.json');
                });
            } else {
                downloadBlob(blob, 'genius-backup.json');
            }
            toast('–≠–∫—Å–ø–æ—Ä—Ç ‚úì', false);
        }

        function importJSON(input) {
            var file = input.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (data.competitors) compData = data.competitors;
                    if (data.myContent) myData = data.myContent;
                    if (data.stats) stats = data.stats;
                    localStorage.setItem('g_comp', JSON.stringify(compData));
                    localStorage.setItem('g_my', JSON.stringify(myData));
                    saveStats();
                    render();
                    updateStats();
                    updateStreakDays();
                    checkAch();
                    closeSettingsModal();
                    toast('–ò–º–ø–æ—Ä—Ç ‚úì', false);
                } catch(err) {
                    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                }
            };
            reader.readAsText(file);
        }

        function clearAll() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?')) return;
            compData = [];
            myData = [];
            stats = { streak: 0, last: null, unlocked: [], days: {} };
            localStorage.removeItem('g_comp');
            localStorage.removeItem('g_my');
            localStorage.removeItem('g_stats');
            render();
            updateStats();
            updateStreakDays();
            closeSettingsModal();
            toast('–û—á–∏—â–µ–Ω–æ', false);
        }

        function exportCSV() {
            var data = currentTab === 'comp' ? compData : myData;
            if (data.length === 0) { toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', false); return; }

            var csv = '\uFEFF';
            if (currentTab === 'comp') {
                csv += '–î–∞—Ç–∞,–°—Å—ã–ª–∫–∞,–•—É–∫,–§–æ—Ä–º–∞—Ç,–ü—Ä–æ—Å–º–æ—Ç—Ä—ã,–†–µ–ø–æ—Å—Ç—ã,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏,–ò–Ω—Å–∞–π—Ç,–ò–¥–µ—è\n';
                data.forEach(function(item) {
                    csv += '"' + item.date + '","' + (item.link||'') + '","' + csvEsc(item.hook) + '","' + (item.format||'') + '",' + (item.views||0) + ',' + (item.shares||0) + ',' + (item.comments||0) + ',"' + csvEsc(item.insight) + '","' + csvEsc(item.idea) + '"\n';
                });
            } else {
                csv += '–î–∞—Ç–∞,–°—Å—ã–ª–∫–∞,–•—É–∫,–ü—Ä–æ—Å–º–æ—Ç—Ä—ã,–ü–æ–¥–ø–∏—Å—á–∏–∫–∏,–ò–Ω—Å–∞–π—Ç\n';
                data.forEach(function(item) {
                    csv += '"' + item.date + '","' + (item.link||'') + '","' + csvEsc(item.hook) + '",' + (item.views||0) + ',' + (item.subs||0) + ',"' + csvEsc(item.insight) + '"\n';
                });
            }

            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            var filename = 'genius_' + currentTab + '.csv';
            if (navigator.share) {
                var file = new File([blob], filename, { type: 'text/csv' });
                navigator.share({ files: [file] }).catch(function() {
                    downloadBlob(blob, filename);
                });
            } else {
                downloadBlob(blob, filename);
            }
            toast('–≠–∫—Å–ø–æ—Ä—Ç ‚úì', false);
        }

        function downloadBlob(blob, name) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }

        function saveStats() {
            localStorage.setItem('g_stats', JSON.stringify(stats));
        }

        function parseNum(s) {
            if (!s) return 0;
            s = String(s).toLowerCase().replace(/\s/g, '').replace(/–º|m/g, 'm').replace(/–∫|k/g, 'k');
            if (s.indexOf('m') > -1) return Math.round(parseFloat(s) * 1000000);
            if (s.indexOf('k') > -1) return Math.round(parseFloat(s) * 1000);
            return parseInt(s.replace(/\D/g, '')) || 0;
        }

        function formatNum(n) {
            if (!n) return '0';
            n = parseInt(n);
            if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + '–º';
            if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, '') + '–∫';
            return String(n);
        }

        function formatDate(s) {
            if (!s) return '';
            var d = new Date(s);
            var m = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞—è', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
            return d.getDate() + ' ' + m[d.getMonth()];
        }

        function esc(s) {
            if (!s) return '';
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function csvEsc(s) {
            return s ? String(s).replace(/"/g, '""') : '';
        }

        document.querySelectorAll('.modal-bg').forEach(function(m) {
            m.addEventListener('click', function(e) {
                if (e.target === m) m.classList.remove('show');
            });
        });
    </script>
</body>
</html>
